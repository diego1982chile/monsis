{% block stylesheets %}
{% endblock %}
{% extends 'base.html.twig' %}
{% form_theme edit_form 'bootstrap_3_layout.html.twig' %}
{% block body %}
    <h1>Incidencia edit</h1>
    <div class="form" style="width:60%;display:none">
        {{ form_start(edit_form) }}
        {{ form_errors(edit_form) }}        
        {{ form_row(edit_form.componente) }}
        {{ form_row(edit_form.categoriaIncidencia) }}
        {{ form_label(edit_form.numeroTicket) }}
        <div class="form-group input-group">        
            <span class="input-group-addon" id="basic-addon2">Ticket#</span>
            {{ form_widget(edit_form.numeroTicket) }}            
        </div>                
        {{ form_row(edit_form.descripcion) }}
        {{ form_row(edit_form.severidad) }}        
        <input type="submit" value="Editar" style="display:none" class="btn btn-primary active" />        
        <button id="validate_form" class="btn btn-primary active" type="button">Modificar</button>        
        <button id="delete" class="btn btn-warning active" type="button" style="float:right">Eliminar</button>
    {{ form_end(edit_form) }}
    </div>
    <br>
    <ul>
        <li>
            <a href="{{ path('incidencia_index') }}">Volver</a>
        </li>                            
        {% if incidencia.estadoIncidencia.nombre in ['Pendiente MT'] and incidencia.mantenciones|length == 0 %}
            <li>
                <a href="{{ path('incidencia_mantencion', { 'id': incidencia.id }) }}">Levantar Mantención</a>
            </li>
        {% endif %}                            
    </ul>
    <div class="form" style="width:60%;display:none">
        {{ form_start(delete_form) }}
            <input type="submit" style="display:none" value="Eliminar" class="btn btn-warning active">                
        {{ form_end(delete_form) }}
    </div>          
{% endblock %}
{% block javascripts %}
<script>
    
$( window ).load(function() {
   $('.form').show();
});    
    
$(function() {
    $( "#incidencia_fechaReporte_date" ).datepicker();    
});  

var $origen = $('#incidencia_origenIncidencia');

var $codigoInterno = $('#incidencia_numeroTicket');
var $validar= $('#validar');
// When sport gets selected ...

var $componente = $('#incidencia_componente');

var loader = new Image();
loader.src = '{{ asset('bundles/monsis/images/loader-minitrans.gif') }}';
loader.className = 'loader';

var edit = new Image();
edit.src = '{{ asset('bundles/monsis/images/edit_2.png') }}';
edit.className = 'save';

var del = new Image();
del.src = '{{ asset('bundles/monsis/images/delete_3.png') }}';
del.className = 'save';

$validateForm=$('#validate_form');
$validateForm.append(edit);

$deleteForm=$('#delete');
$deleteForm.append(del);

// When sport gets selected ...
$componente.change(function() {
  $('#incidencia_categoriaIncidencia').parent().children(':eq(0)')
    .append('<img class="loader" alt="" style=";margin-left:10px" src="{{ asset('bundles/monsis/images/loader-minitrans.gif') }}">');    
  // ... retrieve the corresponding form.
  var $form = $(this).closest('form');
  // Simulate form data, but only include the selected sport value.
  var data = {};
  data[$componente.attr('name')] = $componente.val(); 
  // Submit data via AJAX to the form's action path.
  $.ajax({
    url : $form.attr('action'),
    type: $form.attr('method'),
    data : data,
    success: function(html) {
      // Replace current position field ...
      $('#incidencia_categoriaIncidencia').replaceWith(
        // ... with the returned one from the AJAX response.
        $(html).find('#incidencia_categoriaIncidencia')                
      );
      // Position field now displays the appropriate positions.
      $('.loader').remove();
    }
  });
});

$validar.click(function(){
    
  $(this).parent().children(':eq(0)')
    .append('<img class="loader" alt="" style=";margin-left:10px" src="{{ asset('bundles/monsis/images/loader-minitrans.gif') }}">');    
  // ... retrieve the corresponding form.  
  // Simulate form data, but only include the selected sport value.
  var data = {};
  data['codigoInterno'] = $('#incidencia_numeroTicket').val(); 
  data['id'] = $('#incidencia_id').val();
  // Submit data via AJAX to the form's action path.
  $.post("{{ path('incidencia_check') }}",data,function(data){
      if(data.error){          
          $('#incidencia_numeroTicket').focus();
          $('#incidencia_numeroTicket').qtip({ // Grab some elements to apply the tooltip to
                content: {
                    text: '<img alt="" style="width:20px;height:20px" src="{{ asset('bundles/monsis/images/exclamation_2.png') }}"> '+data.message
                },
                show: {
                    ready: true,
                    delay: 50
                },
                style: {
                    classes: 'ui-state-error',
                    def: false,                    
                },            
                position: {
                        my: 'top left',  // Position my top left...
                        at: 'bottom center', // at the bottom right of...
                        target: $('#incidencia_numeroTicket') // my target
                    }                
            });
          //$('#servicio_codigoInterno').before('<ul class="errors"><li>'+data.message+'</li></ul>');                    
      } 
      else{
        $('.qtip').remove();
        $('#incidencia_componente').prop('disabled',false);
      }
      // Position field now displays the appropriate positions.
      $('.loader').remove();    
  });    
});

$validateForm.click(function(){

  $(edit).replaceWith(loader);    
  $(this).attr('disabled',true);

  var error = false;
  var data = {};
  data['numeroTicket'] = $('#incidencia_numeroTicket').val(); 
  data['id'] = $('#incidencia_id').val();
  // Submit data via AJAX to the form's action path.
  $('.form-group').each(function(){           
       $field=$(this).find('input,select,textarea');              
       
       if($field.val()===''){   
            error = true;
            $field.focus();
            $field.qtip({ // Grab some elements to apply the tooltip to
                content: {
                    text: '<span class="glyphicon glyphicon glyphicon-exclamation-sign"></span>&nbsp;Completa este campo'
                },
                show: {
                    ready: true,
                    delay: 50
                },
                style: {
                    classes: 'ui-state-error',
                    def: false,                    
                },            
                position: {
                        my: 'top left',  // Position my top left...
                        at: 'bottom center', // at the bottom right of...
                        target: $field // my target
                    }                
            });
            return false;
       }           
       else{
            $('.qtip').remove();
       }
  });
  
    if(error){
        $(loader).replaceWith(edit);
        $validateForm.attr('disabled',false);
        return false;
    }
  
  $.post("{{ path('incidencia_check') }}",data,function(data){
      if(data.error){          
          $('#incidencia_numeroTicket').focus();
          $('#incidencia_numeroTicket').qtip({ // Grab some elements to apply the tooltip to
                content: {
                    text: '<span class="glyphicon glyphicon glyphicon-exclamation-sign"></span>&nbsp;'+data.message
                },
                show: {
                    ready: true,
                    delay: 50
                },
                style: {
                    classes: 'ui-state-error',
                    def: false,                    
                },            
                position: {
                        my: 'top left',  // Position my top left...
                        at: 'bottom center', // at the bottom right of...
                        target: $('#incidencia_numeroTicket') // my target
                    }                
            });          
            $(loader).replaceWith(edit);
            $validateForm.attr('disabled',false);
      } 
      else{        
        $('form[name="incidencia"]').submit();
      }
      // Position field now displays the appropriate positions.      
  });    
});

$deleteForm.click(function(){
        
    if(confirm("¿Está seguro que desea eliminar esta incidencia?")){
        $(del).replaceWith(loader);    
        $(this).attr('disabled',true);

        $('form[name="form"]').submit();
    }    
});
</script>
{% endblock %}